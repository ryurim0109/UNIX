## 3장 파일 입출력

### 파일 서술자

---

- 커널에서는 열린 파일들을 항상 파일 서술자를 통해서 지칭한다. 파일 서술자는 음이 아닌 정수이다. 기존 파일을 열거나 새 파일을 생성할 때 커널은 해당 파일에 대한 파일 서술자를 프로세스에게 돌려준다. 파일을 읽거나 쓸 때에는 open이나 creat가 돌려준 파일 서술자를 read나 write의 인수로 넘겨주어서 해당 파일을 지정한다.

### open openat 함수

---

#### 기본 함수 원형

| 함수   | 설명                                                                           |
| ------ | ------------------------------------------------------------------------------ |
| open   | 지정된 경로명으로 파일을 열거나 생성함                                         |
| openat | 상대 경로를 특정 디렉토리 파일 디스크립터에 대해 해석하여 파일을 열거나 생성함 |

#### 주요 차이점

| 특성           | open                         | openat                                                             |
| -------------- | ---------------------------- | ------------------------------------------------------------------ |
| 경로 해석      | 현재 작업 디렉토리 기준      | dirfd 파라미터로 지정된 디렉토리 기준                              |
| 추가 파라미터  | 없음                         | dirfd (디렉토리 파일 디스크립터)                                   |
| 상대 경로 처리 | 항상 현재 작업 디렉토리 기준 | dirfd가 AT_FDCWD면 현재 작업 디렉토리, 아니면 지정된 디렉토리 기준 |
| 절대 경로 처리 | 항상 절대 경로로 해석        | dirfd 무시하고 항상 절대 경로로 해석                               |

#### 플래그(flags) 옵션

| 플래그      | 설명                                                              |
| ----------- | ----------------------------------------------------------------- |
| O_RDONLY    | 읽기 전용으로 파일을 연다                                         |
| O_WRONLY    | 쓰기 전용으로 파일을 연다                                         |
| O_RDWR      | 읽기/쓰기 모두 가능하게 파일을 연다                               |
| O_EXEC      | 실행 전용으로 파일을 연다                                         |
| O_SEARCH    | 디렉토리에 대한 검색 전용으로 연다                                |
| O_APPEND    | 데이터를 항상 파일 끝에 추가한다                                  |
| O_CLOEXEC   | fork/exec 시 파일 디스크립터를 자동으로 닫는다                    |
| O_CREAT     | 파일이 존재하지 않으면 새로 생성한다                              |
| O_DIRECTORY | pathname이 디렉토리가 아니면 실패한다                             |
| O_EXCL      | O_CREAT와 함께 사용 시 파일이 이미 존재하면 실패한다              |
| O_NOCTTY    | 터미널 장치를 열 때 제어 터미널이 되지 않게 한다                  |
| O_NOFOLLOW  | 심볼릭 링크를 따라가지 않는다                                     |
| O_NONBLOCK  | 파일을 비차단 모드로 연다                                         |
| O_TRUNC     | 파일이 존재하고 쓰기 모드로 열리면 크기를 0으로 자른다            |
| O_SYNC      | 모든 I/O 작업이 물리적으로 완료될 때까지 기다린다                 |
| O_DSYNC     | 데이터 무결성에 필요한 I/O가 완료될 때까지 기다린다               |
| O_RSYNC     | 동일 위치의 모든 이전 쓰기가 완료될 때까지 읽기 작업을 지연시킨다 |
| O_TTY_INIT  | 터미널 장치를 열 때 기본 터미널 속성으로 초기화한다               |

### creat 함수 & close 함수

---

- 새 파일을 creat 함수를 호출해서 생성할 수 있다.
- 이전에는 존재하지 않는 파일은 열 수 없어서 새로운 파일을 생성하기 위한 개별적인 시스템 호출이 필요했다.
- 프로세스가 종료되면 프로세스에 열려있던 모든 파일을 커널이 자동으로 닫는다.

### lseek 함수

- 모든 열린 파일에는 현재 파일 오프셋이 있다. 보통의 경우 파일 오프셋은 파일 시작에서부터 센 바이트 수를 의미하는 음이 아닌 정수이다.
- 열린 파일의 오프셋을 명시적으로 설정할 때에는 lseek 함수를 사용한다.
- lseek 호출이 성공하면 새 파일 오프셋이 반환 => 오프셋 바이트 수를 0으로 설정 => 기준 위치를 현재 위치로 설정하면 현재 오프셋을 알 수 있다.
  (탐색 기법)

### read 함수

- read 호출이 성공하면 읽어 들인 바이트 개수가 반환됨. 파일 끝에 도달한 경우 0이 반환됨

### write 함수

- 열린 파일 자료를 기록할 때 사용. 디스크에 남은 용량이 없거나 주어진 프로세스에 대한 파일 크기 한계를 넘었을 때 write가 오류를 생성함.
- 정규 파일에 대한 쓰기 연산은 파일의 현재 오프셋에서 시작한다.
